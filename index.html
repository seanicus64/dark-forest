<!DOCTYPE html>
<html>
<head>
</head>
<body>
<button id="zoom-in" onclick="zoom_in()">Zoom in</button>
<button id="zoom-out" onclick="zoom_out()">Zoom out</button>
<button id="pan-left" onclick="pan_left()">Pan left</button>
<button id="pan-up" onclick="pan_up()">Pan up</button>
<button id="pan-down" onclick="pan_down()">Pan down</button>
<button id="pan-right" onclick="pan_right()">Pan right</button>
<label for="label_check">Labels:</label>
<input type="checkbox" id="label_check" onclick="toggle_labels()">
<label for="hitbox_check">Hitboxes:</label>
<input type="checkbox" id="hitbox_check" onclick="toggle_hitboxes()">
<p id="status">hello world</p>
<canvas id="canvas" width=1000 height=1000">hello world</canvas>
<script> 
document.getElementById("status").innerHTML = "HELLO WRLD";
var status_ = document.getElementById("status");

var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");
var zoom_level = 0;
var phys_width = 1000;
var phys_height = 1000;
var zoom_factor = 2;
var virt_x = 1000000;
var virt_y = 1000000;
var virt_width;
var virt_height;
var show_labels;
var show_hitboxes = false;
var hitboxes = [];
zoom_level = 14;
virt_x = 5000000000000;
virt_y = 5000000000000;
var dragging = false;
canvas.addEventListener("mousedown", dragStart, false);
canvas.addEventListener("mousemove", drag, false);
canvas.addEventListener("mouseup", dragEnd, false);
var first_drag_position, second_drag_position;
canvas.addEventListener("dblclick", test, false);
canvas.addEventListener("wheel", wheeltest, false);
function wheeltest(event) {
    event.preventDefault();
    console.log(event.deltaX);
    console.log(event.deltaY);
    console.log(event.deltaZ);
    if (event.deltaY > 0){
        zoom_level += 0.1;
        redraw();
        }
    if (event.deltaY < 0){
        zoom_level -= 0.2;
        redraw();
        }

}
function test(event) {
    var position = getCanvasCoordinates(event);
    console.log("successfully test");
//    //for (hitbox_) in 
    hitboxes.forEach(function(hb){
        if (hb.west <= position["x"] && position["x"] < hb.east) {
//            console.log("in x coordinates")
            if (hb.north <= position["y"] && position["y"] < hb.south) {
                console.log("in x and y coordinates");
                status_.innerHTML = hb.planet.name;
                virt_x = hb.planet.x;
                virt_y = hb.planet.y;
                redraw();
                return;
                }
            }
        })
}

function dragStart(event) {
    first_drag_position = getCanvasCoordinates(event);
    console.log("dragStart");
    dragging = true;

}
function drag(event) {
    if (!dragging){
        return
        }
    console.log("dragging");

}
function dragEnd(event) {
    var x_diff, y_diff;
    console.log("dragEnd");
    second_drag_position = getCanvasCoordinates(event);
    console.log(first_drag_position);
    console.log(second_drag_position);

    dragging = false;
    x_diff = second_drag_position["x"] - first_drag_position["x"];
    y_diff = second_drag_position["y"] - first_drag_position["y"];
    console.log(x_diff, y_diff);
    v1 = phys_to_virt(first_drag_position["x"], first_drag_position["y"]);
    v2 = phys_to_virt(second_drag_position["x"], second_drag_position["y"]);
    var virt_differences = phys_to_virt(x_diff, y_diff);
    console.log(v1);
    console.log(v2);
    virt_x -= (v2[0] - v1[0]);
    virt_y -= (v2[1] - v1[1]);
    //virt_x -= virt_differences[0];
    //virt_y -= virt_differences[1];
    redraw();

    console.log(virt_differences);

}
function getCanvasCoordinates(event) {
    var x, y;
    x = event.clientX - canvas.getBoundingClientRect().left,
    y = event.clientY - canvas.getBoundingClientRect().top;
    return {x: x, y: y};
    
}
ctx.fillStyle = "black";
ctx.fillRect(0, 0, canvas.width, canvas.height);
//let socket = new WebSocket("wss://javascript.info/article/websocket/demo/hello");
let socket = new WebSocket("ws://127.0.0.1:9000")
socket.onopen = function(e) {
    console.log("connection established");
    console.log("sending to server");

    socket.send("cucumber");
    };
function toggle_labels(){
    console.log("toggling labels");
    var checkbox = document.getElementById("label_check");
    if (checkbox.checked == true){
        show_labels = true;
        console.log("showing labels");
        }
    else {
        show_labels = false;
        console.log("hiding labels");
        }
    redraw();
    }
function toggle_hitboxes() {
    var checkbox = document.getElementById("hitbox_check");
    if (checkbox.checked == true) {
        show_hitboxes = true;
        }
    else {
        show_hitboxes = false;
        }
    redraw();
    }
function Celestial(id, x, y, radius, color, is_star) {
    this.id = id;
    this.x = x;
    this.y = y;
    this.radius = radius;
    this.color = color;
    this.is_star = is_star;
    this.brilliance = Math.floor(Math.random() * 10);
    this.fruit = "banana";

}
class Celest {
    constructor(id, x, y, radius, color, is_star) {
        this.id = id;
        this.x = x;
        this.y = y;
        this.radius = radius;
        this.color = color;
        this.is_star = is_star;
        this.brilliance = Math.floor(Math.random() * 10);
        this.banana();
        }
    banana() {
        console.log("I like bananas");
        //name = "apple";

        var amount_of_letters = Math.floor(Math.random()*8) + 4;
        console.log(amount_of_letters);
        this.name = "";
        var i = 0;
        var temp;
        var letter;
        var alphabet = "abcdefghijklmnopqrstuvwxyz";
        var which_letter;
        var name_letters = [];
        while (i<amount_of_letters){
            which_letter = Math.floor(Math.random()*26)
            console.log(i, alphabet[which_letter]);
//            temp = name.concat(alphabet[which_letter]);
//            console.log(temp);
            name_letters.push(alphabet[which_letter]);
            //name = temp;
            //console.log(name);
            //temp = name.concat(alphabet[which_letter]);
            //name = temp;
            //console.log(name);
            i++;
            }
        this.name = name_letters.join("");
        console.log(this.name);

        }
    }
function zoom_in(){
    zoom_level -= 1;
    redraw();
}
function zoom_out(){
    zoom_level += 1;
    redraw();
    }
function pan_left(){
    virt_x -= (virt_width/10);
    redraw();
}
function pan_right(){
    virt_x += (virt_width/10);
    redraw();
}
function pan_up(){
    virt_y-= (virt_width/10);
    redraw();
}
function pan_down(){
    virt_y+= (virt_width/10);
    redraw();
}
var star_data;
function redraw(){
    var pixel_height = Math.floor(10000000000000 / canvas.height);
    var pixel_width = Math.floor(10000000000000 / canvas.width);
    var x;
    var y;
    var min_virt_x, min_virt_y, max_virt_x, max_virt_y;
    var within_x, within_y;
    var hitbox_coords;
    hitboxes = [];

    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    virt_width = phys_width * zoom_factor ** zoom_level * 1000000;
    virt_height = phys_height * zoom_factor ** zoom_level * 1000000;
    min_virt_x = virt_x - (virt_width/2);
    min_virt_y = virt_y - (virt_height/2);
    max_virt_x = virt_x + (virt_width/2);
    max_virt_y = virt_y + (virt_height/2);

    

    allstars.forEach(function(star){
//        x = Math.floor(star.x / pixel_width);
//        y = Math.floor(star.y / pixel_height);
//        console.log(x);
//        make_star(x, y, star.id, star.color);
        //console.log(min_virt_x, star.x, max_virt_x);
        within_x = (min_virt_x <= star.x && star.x < max_virt_x);
        within_y = (min_virt_y <= star.y && star.y < max_virt_y);
        //console.log(within_x, star.brilliance);
        if (within_x && within_y && (star.brilliance +4>= zoom_level|| star.brilliance >= 0))
        {
            var coords;
            coords = draw_celestial(star);

            
            if (zoom_level <= 8 && show_labels == true){
                ctx.fillText(star.name, coords[0]-20, coords[1]-5);
                }
            if (zoom_level <= 8 && show_hitboxes == true) {
                hitbox_coords = [coords[0]-40, coords[1]-25, coords[0]+40, coords[1]+25];
                hitbox_ = new hitbox(star, coords[0]-40, coords[1]-25, coords[0]+40, coords[1]+25);
                console.log(hitbox_);
                console.log(hitbox_.east);
                hitboxes.push(hitbox_);
                console.log("drawing hitboxes");
                ctx.strokeStyle = "white";
                ctx.beginPath();
                ctx.rect(coords[0]-40, coords[1]-25, 80, 50);
//                ctx.rect(hitbox_.east, hitbox_.north, hitbox_.west, hitbox_.south);
                ctx.stroke();
                }
        }
    });
    status_.innerHTML = zoom_level;
    console.log(virt_width, virt_height);
    console.log(hitboxes);

}
class hitbox {
    constructor(planet, west, north, east, south){
        this.planet = planet;
        this.west = west;
        this.north = north;
        this.east = east;
        this.south = south;
        }
    };

function getCanvasa()
{}
function draw_celestial(celestial){
    var phys_x, phys_y;
    var coords;
    coords = virt_to_phys(celestial.x, celestial.y);
    phys_x = Math.floor(coords[0]);
    phys_y = Math.floor(coords[1]);
    //console.log("BBBBBB");
    //console.log(coords);
    make_star(phys_x, phys_y, 43, celestial.color);
    return [phys_x, phys_y]
    



}
function phys_to_virt(phys_x, phys_y){
    var x, y;
    console.log(phys_x, phys_width, zoom_factor, zoom_level, virt_x);
    console.log(phys_x - (phys_width/2));
    console.log(zoom_factor**zoom_level*1000000);
    x = (phys_x - (phys_width/2)) * (zoom_factor**zoom_level*1000000) + virt_x;
    y = (phys_y - (phys_height/2)) * (zoom_factor**zoom_level*1000000) + virt_y;
//    x = phys_x * (zoom_factor**zoom_level*1000000) + virt_x;
//    y = phys_y * (zoom_factor**zoom_level*1000000) + virt_y;
    return [x, y]
    }
function virt_to_phys(x, y){
    var new_x, new_y;
    new_x = (x - virt_x) / (zoom_factor ** zoom_level * 1000000) + (phys_width/2);
    new_y = (y - virt_y) / (zoom_factor ** zoom_level * 1000000) + (phys_height/2);
    return [new_x, new_y];
}
function create_stars() {
    var innerstring = starlist[1];
    innerstring += starlist[1][1];
    status_.innerHTML = innerstring;
    starlist.forEach(function (star){
        var celestial = new Celest(star[0], star[1], star[2], star[3], star[4], star[5]);
        allstars.push(celestial);
    });

}
var starlist;
var banana;// = 43;
var allstars = [];

socket.onmessage = function(event) {
    message = `[message] Data received from server: ${event.data}`;
    star_data = JSON.parse(event.data);
    starlist = star_data["ITEMS"];
    switch(star_data["MESSAGE_TYPE"]){
        case "STAR_LIST":
        {
            console.log("it's a starlist");
            create_stars();
            redraw();
            break;
        }
    }
    };
socket.onclose = function(event) {
    if (event.wasClean) {
        alert(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
    } else {
        alert('[close] connection died');
    }
};

socket.onerror = function(error) {
    alert(`[error] ${error.message}`);
    };

var x, y;
var purple, blue, red, yellow, orange, red, white;
purple = [255, 255, 0];
var color_dict = {
    test:   [255,   128,0 ,        255],

    blue:   [  0,   0, 255,        255],
    green:  [  0, 255,   0,        255],
    teal:   [  0, 255, 255,        255],
    red:    [255,   0,   0,        255],
    purple: [255,   0, 255,        255],
    yellow: [255, 255,   0,        255],
    white:  [255, 255, 255,        255],
    orange: [255, 127,   0,        255],
}
function change_color(color){
    color = color_dict[color];
    d[0] = color[0];
    d[1] = color[1];
    d[2] = color[2];
    d[3] = color[3];

}
function make_star(x, y, i, color){
//    console.log(color);
//    console.log(i);
    ctx.fillStyle = color;
    change_color(color);
//    color = color_dict[color];
//    console.log(color);
//    d[0] = color[0];
//    d[1] = color[1];
//    d[2] = color[2];
//    d[3] = color[3];

    ctx.putImageData(image_data, x, y);
    }

var x = 0;
var y = 0;
var number_of_stars = 5000;
var i = 0;
var image_data = ctx.createImageData(1, 1);
var d = image_data.data;



</script>
</body>
</html>
